# Требования к безопасности интеграций Умный дом

## 1. Требования к безопасности данных

### 1.1 Биометрические данные (лица)
- Хранение только в зашифрованном виде (AES-256)
- Использование HashiCorp Vault для управления ключами
- Данные не передаются партнёру в открытом виде — только хэши/векторы
- Срок хранения: согласно согласию субъекта ПДн
- Право на удаление: немедленное по запросу

### 1.2 Номера автомобилей
- Классификация: конфиденциальные данные
- Хранение в зашифрованной БД
- Передача партнёру: только для проверки доступа, без хранения на стороне партнёра
- Логирование всех операций с номерами

### 1.3 Общие требования
- Шифрование данных at-rest (TDE в PostgreSQL)
- Шифрование данных in-transit (TLS 1.3)
- Маскирование в логах
- Резервное копирование с шифрованием

---

## 2. Протоколы аутентификации и авторизации

### 2.1 Аутентификация пользователей (собственников)
- OAuth 2.0 + OpenID Connect через Keycloak
- MFA обязательна для управления биометрией
- JWT токены с коротким сроком жизни (15 мин)
- Refresh токены: 7 дней, ротация при каждом использовании

### 2.2 Аутентификация между системами
- **PropDevelopment → Партнёр**: OAuth 2.0 Client Credentials + mTLS
- **Партнёр → PropDevelopment**: API Key + mTLS + IP whitelist
- Сертификаты: выданы корпоративным CA, срок 1 год

### 2.3 Авторизация
- RBAC на уровне Keycloak
- ABAC для проверки tenant_id (собственник видит только свои устройства)
- Роли:
  - `owner:read` — просмотр устройств
  - `owner:manage` — управление доступом (добавление лиц/номеров)
  - `admin:audit` — просмотр логов

---

## 3. Схема взаимодействия систем

### 3.1 Компоненты

| Компонент | Назначение |
|-----------|------------|
| smart-home-service | Бизнес-логика интеграции |
| smart-home-db | Хранение настроек устройств |
| biometric-vault | Шифрование биометрии (Vault) |
| API Gateway | mTLS терминация, rate limiting |

### 3.2 Потоки данных

**Регистрация лица для домофона:**
```
1. Собственник → Mobile App: загрузка фото
2. Mobile App → auth-service: проверка MFA
3. Mobile App → smart-home-service: передача фото
4. smart-home-service → biometric-vault: шифрование
5. smart-home-service → Партнёр API: передача вектора (не фото)
6. Партнёр → Домофон: синхронизация
```

**Открытие домофона:**
```
1. Домофон → Партнёр: захват лица
2. Партнёр → API Gateway: запрос верификации
3. API Gateway → smart-home-service: проверка
4. smart-home-service → biometric-vault: расшифровка вектора
5. smart-home-service → Партнёр: результат (да/нет)
6. Партнёр → Домофон: команда открытия
```

### 3.3 Требования к API Gateway
- Rate limiting: 100 req/min на устройство
- Timeout: 5 секунд
- Circuit breaker: при 5 ошибках подряд
- Логирование всех запросов

### 3.4 Требования к партнёру
- Не хранить биометрические данные дольше 24 часов
- Предоставить SLA 99.9%
- Уведомлять об инцидентах в течение 1 часа
- Ежегодный аудит безопасности (SOC 2)

---

## 4. Соответствие требованиям

| Требование | Решение |
|------------|---------|
| ФЗ-152 (ПДн) | Согласие на обработку биометрии, право на удаление |
| GDPR (если применимо) | Data minimization, право на забвение |
| PCI DSS (косвенно) | Шифрование, контроль доступа, логирование |
